{% extends "base.html" %}

{% block title %}Log Analyzer - SecureOps Toolkit{% endblock %}

{% block content %}
<div x-data="analyzerApp()" class="space-y-6">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Log Analyzer</h1>
        <p class="text-gray-400">Upload log files to detect suspicious activity and security events</p>
    </div>

    <!-- How Analysis Works Section -->
    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-200 mb-4">How Analysis Works</h2>
        <ul class="space-y-2 text-sm text-gray-400">
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Rule-Based Matching:</strong> The analyzer uses pattern matching to identify common security issues in logs.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>What It Detects:</strong> Failed login attempts, SSH authentication failures, sudo usage, user account changes, suspicious IP patterns, brute-force indicators, privilege escalation attempts, and file access anomalies.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Severity Levels:</strong> Findings are classified as high, medium, or low priority based on patterns detected.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Limitations:</strong> This is not a full SIEM. It may produce false positives and should not be the only security monitoring tool.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Privacy:</strong> Uploaded files are analyzed in memory and never stored on disk.</span>
            </li>
        </ul>
    </div>

    <!-- Upload Section -->
    <div class="bg-slate-800 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-slate-800/50 transition-all cursor-pointer" 
         @drop.prevent="handleFileDrop"
         @dragover.prevent="isDragging = true"
         @dragleave="isDragging = false"
         :class="isDragging ? 'border-blue-400 bg-blue-500/10' : ''">
        
        <input 
            type="file" 
            @change="handleFileSelect" 
            accept=".log,.txt" 
            class="hidden"
            x-ref="fileInput"
            id="fileInput"
        >
        
        <div @click="$refs.fileInput.click()" class="cursor-pointer">
            <svg class="h-12 w-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-200 mb-2">Upload log file</p>
            <p class="text-sm text-gray-400">Drag and drop a .log or .txt file here, or click to browse</p>
            <p class="text-xs text-gray-500 mt-2">Maximum 5MB</p>
        </div>
    </div>

    <!-- Status Messages -->
    <template x-if="loading">
        <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4 text-blue-300 text-center">
            <div class="flex items-center justify-center space-x-2">
                <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                <span>Analyzing log file...</span>
            </div>
        </div>
    </template>

    <template x-if="error">
        <div class="bg-red-500/10 border border-red-500 rounded-lg p-4 text-red-300">
            <p class="font-semibold">Analysis Error</p>
            <p x-text="error" class="text-sm mt-1"></p>
        </div>
    </template>

    <template x-if="uploadSuccess">
        <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-green-300">
            <p class="font-semibold">File analyzed successfully</p>
        </div>
    </template>

    <!-- Results Section -->
    <template x-if="findings.length > 0">
        <div class="space-y-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">Analysis Results</h2>
                <div class="text-sm text-gray-400">
                    <span x-text="`${findingsByType.high.length} high priority`"></span>
                    <span class="mx-2">|</span>
                    <span x-text="`${findingsByType.medium.length} medium`"></span>
                    <span class="mx-2">|</span>
                    <span x-text="`${findingsByType.low.length} low priority`"></span>
                </div>
            </div>

            <!-- Filter by severity -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button 
                    @click="severityFilter = null"
                    :class="severityFilter === null ? 'bg-blue-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    All
                </button>
                <button 
                    @click="severityFilter = 'high'"
                    :class="severityFilter === 'high' ? 'bg-red-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    High
                </button>
                <button 
                    @click="severityFilter = 'medium'"
                    :class="severityFilter === 'medium' ? 'bg-amber-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    Medium
                </button>
                <button 
                    @click="severityFilter = 'low'"
                    :class="severityFilter === 'low' ? 'bg-green-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    Low
                </button>
            </div>

            <!-- Findings List -->
            <div class="space-y-3">
                <template x-for="(finding, index) in filteredFindings" :key="index">
                    <div 
                        x-data="{ detailsOpen: false }"
                        class="border rounded-lg overflow-hidden relative smooth-hover transition-transform duration-200 hover:-translate-y-0.5 hover:scale-105 hover:shadow-lg hover:shadow-black/30"
                        :class="getSeverityClass(finding.severity)"
                    >
                        <div class="absolute inset-0 bg-black/45 pointer-events-none rounded-lg"></div>
                        <div class="relative z-10">
                            <button
                                @click="detailsOpen = !detailsOpen"
                                class="w-full px-4 py-3 flex items-center justify-between bg-opacity-50 smooth-hover"
                                :class="getSeverityBgClass(finding.severity)"
                            >
                            <div class="flex items-start space-x-3 flex-1 text-left">
                                <span 
                                    class="inline-block px-2 py-1 rounded text-xs font-semibold mt-0.5"
                                    :class="getSeverityTagClass(finding.severity)"
                                    x-text="finding.severity.toUpperCase()"
                                ></span>
                                <div>
                                    <p class="font-semibold text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.55);" x-text="finding.rule_name"></p>
                                    <p class="text-sm text-white" x-text="finding.description"></p>
                                </div>
                            </div>
                            <svg 
                                class="h-5 w-5 flex-shrink-0 transition-transform duration-200"
                                :class="detailsOpen ? 'rotate-180' : ''"
                                fill="none" 
                                stroke="currentColor" 
                                viewBox="0 0 24 24"
                            >
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                        </button>

                        <!-- Details -->
                        <div x-show="detailsOpen" class="slide-enter">
                            <div class="px-4 py-3 bg-opacity-20" :class="getSeverityBgClass(finding.severity)">
                                <h4 class="text-sm font-semibold mb-2 text-gray-300">Matched log lines:</h4>
                                <div class="space-y-1">
                                    <template x-for="(line, i) in finding.matched_lines" :key="i">
                                        <div class="bg-slate-900 p-2 rounded text-xs font-mono text-gray-300 break-all overflow-auto" x-text="escapeHtml(line)"></div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Clear Results -->
            <div class="text-center pt-4">
                <button 
                    @click="clearResults()"
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-gray-200 rounded text-sm smooth-hover transition-colors"
                >
                    Analyze Another File
                </button>
            </div>
        </div>
    </template>

    <!-- No findings -->
    <template x-if="findings.length === 0 && uploadSuccess && !loading">
        <div class="text-center py-12 bg-slate-800 border border-slate-700 rounded-lg">
            <p class="text-gray-300 text-lg">✓ No suspicious activity detected</p>
            <p class="text-gray-400 text-sm mt-2">The log file appears to be clean</p>
        </div>
    </template>
</div>

<script>
function analyzerApp() {
    return {
        loading: false,
        error: '',
        uploadSuccess: false,
        findings: [],
        isDragging: false,
        severityFilter: null,

        get findingsByType() {
            return {
                high: this.findings.filter(f => f.severity === 'high'),
                medium: this.findings.filter(f => f.severity === 'medium'),
                low: this.findings.filter(f => f.severity === 'low')
            };
        },

        get filteredFindings() {
            if (!this.severityFilter) return this.findings;
            return this.findings.filter(f => f.severity === this.severityFilter);
        },

        handleFileDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length) {
                this.analyzeFile(files[0]);
            }
        },

        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length) {
                this.analyzeFile(files[0]);
            }
        },

        async analyzeFile(file) {
            const allowedExtensions = ['log', 'txt'];
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedExtensions.includes(extension)) {
                this.error = 'Only .log and .txt files are allowed';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                this.error = 'File is too large (maximum 5MB)';
                return;
            }

            this.loading = true;
            this.error = '';
            this.uploadSuccess = false;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    this.error = data.error || 'An error occurred during analysis';
                } else {
                    this.findings = data.findings;
                    this.uploadSuccess = true;
                    this.error = '';
                }
            } catch (err) {
                this.error = 'Network error: ' + err.message;
            } finally {
                this.loading = false;
            }
        },

        getSeverityClass(severity) {
            const map = {
                'high': 'border-red-500/30',
                'medium': 'border-amber-500/30',
                'low': 'border-green-500/30'
            };
            return map[severity] || 'border-gray-500/30';
        },

        getSeverityBgClass(severity) {
            const map = {
                'high': 'bg-red-500',
                'medium': 'bg-amber-500',
                'low': 'bg-green-500'
            };
            return map[severity] || 'bg-gray-500';
        },

        getSeverityTagClass(severity) {
            const map = {
                'high': 'bg-red-600 text-white font-bold px-2.5 py-1 rounded',
                'medium': 'bg-amber-600 text-white font-bold px-2.5 py-1 rounded',
                'low': 'bg-green-600 text-white font-bold px-2.5 py-1 rounded'
            };
            return map[severity] || 'bg-gray-700 text-gray-100 font-bold px-2.5 py-1 rounded';
        },

        escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        },

        clearResults() {
            this.findings = [];
            this.uploadSuccess = false;
            this.$refs.fileInput.value = '';
        }
    };
}
</script>
{% endblock %}
