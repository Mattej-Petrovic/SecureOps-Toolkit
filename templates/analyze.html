{% extends "base.html" %}

{% block title %}Log Analyzer - SecureOps Toolkit{% endblock %}

{% block content %}
<div x-data="analyzerApp()" class="space-y-6">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Log Analyzer</h1>
        <p class="text-gray-400">Analyze logs to detect suspicious activity and security events</p>
    </div>

    <!-- Input Method Tabs -->
    <div class="flex items-center justify-center mb-2">
        <div class="inline-flex bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
            <button @click="activeTab = 'file'"
                :class="activeTab === 'file' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white hover:bg-slate-700'"
                class="px-4 py-2 text-sm font-medium smooth-hover">Upload File</button>
            <button @click="activeTab = 'text'"
                :class="activeTab === 'text' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:text-white hover:bg-slate-700'"
                class="px-4 py-2 text-sm font-medium smooth-hover">Paste Text</button>
        </div>
    </div>

    <!-- How Analysis Works Section -->
    <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-200 mb-4">How Analysis Works</h2>
        <ul class="space-y-2 text-sm text-gray-400">
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Event Parsing:</strong> Extracts timestamp, level, service, and key=value fields, including quoted values like key="value with spaces". Remaining text is kept as message.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Deterministic Normalization:</strong> Maps Swedish and English phrases to event types using a fixed priority (e.g. privilege_change > account_lockout > WAF > auth_fail > ...).</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Risk Scoring per Entity:</strong> Scores are accumulated per IP and per user from atomic indicators and correlations.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Correlation Windows:</strong> Time-based rules relate events within minutes (e.g. brute-force, spraying, fail→success, WAF+auth, multi-port scans).</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Allowlists & Tuning:</strong> Localhost, health endpoints, and optional internal ranges can be allowlisted. Thresholds and scores are configurable.</span>
            </li>
            <li class="flex items-start space-x-3">
                <span class="text-blue-400 font-bold">•</span>
                <span><strong>Privacy:</strong> Uploaded files are analyzed in memory and never stored on disk.</span>
            </li>
        </ul>
    </div>

    <!-- Upload Section (Tab: Upload File) -->
    <div x-show="activeTab === 'file'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-1"
         class="bg-slate-800 border-2 border-dashed border-slate-600 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-slate-800/50 transition-all cursor-pointer"
         @drop.prevent="handleFileDrop"
         @dragover.prevent="isDragging = true"
         @dragleave="isDragging = false"
         :class="isDragging ? 'border-blue-400 bg-blue-500/10' : ''">
        <input type="file" @change="handleFileSelect" accept=".log,.txt" class="hidden" x-ref="fileInput" id="fileInput">
        <div @click="$refs.fileInput.click()" class="cursor-pointer">
            <svg class="h-12 w-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-200 mb-2">Upload log file</p>
            <p class="text-sm text-gray-400">Drag and drop a .log or .txt file here, or click to browse</p>
            <p class="text-xs text-gray-500 mt-2">Maximum 5MB</p>
        </div>
    </div>

    <!-- Paste Text Section (Tab: Paste Text) -->
    <div x-show="activeTab === 'text'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-1" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-1"
         class="bg-slate-800 border border-slate-700 rounded-lg p-6">
        <label for="logTextArea" class="block text-sm font-medium text-gray-300 mb-2">Paste log text</label>
        <textarea id="logTextArea" x-model="textInput" placeholder="Paste log lines here..." class="w-full h-64 p-4 bg-slate-900 text-gray-100 border border-slate-700 rounded font-mono resize-y placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        <div class="flex items-center justify-between mt-3">
            <p class="text-xs text-gray-400">Tip: You can paste mixed English/Swedish logs.</p>
            <button @click="analyzeText()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm smooth-hover">Analyze Text</button>
        </div>
    </div>

    <!-- Status Messages -->
    <template x-if="loading">
        <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4 text-blue-300 text-center">
            <div class="flex items-center justify-center space-x-2">
                <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                <span>Analyzing...</span>
            </div>
        </div>
    </template>

    <template x-if="error">
        <div class="bg-red-500/10 border border-red-500 rounded-lg p-4 text-red-300">
            <p class="font-semibold">Analysis Error</p>
            <p x-text="error" class="text-sm mt-1"></p>
        </div>
    </template>

    <template x-if="uploadSuccess">
        <div class="bg-green-500/10 border border-green-500 rounded-lg p-4 text-green-300">
            <p class="font-semibold">File analyzed successfully</p>
        </div>
    </template>

    <!-- Results Section -->
    <template x-if="findings.length > 0">
        <div class="space-y-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">Analysis Results</h2>
                <div class="text-sm text-gray-400">
                    <span x-text="`${findingsByType.critical.length} critical`"></span>
                    <span class="mx-2">|</span>
                    <span x-text="`${findingsByType.high.length} high priority`"></span>
                    <span class="mx-2">|</span>
                    <span x-text="`${findingsByType.medium.length} medium`"></span>
                    <span class="mx-2">|</span>
                    <span x-text="`${findingsByType.low.length} low priority`"></span>
                </div>
            </div>

            <!-- Filter by severity -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button 
                    @click="severityFilter = null"
                    :class="severityFilter === null ? 'bg-blue-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    All
                </button>
                <button 
                    @click="severityFilter = 'critical'"
                    :class="severityFilter === 'critical' ? 'bg-red-700 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    Critical
                </button>
                <button 
                    @click="severityFilter = 'high'"
                    :class="severityFilter === 'high' ? 'bg-red-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    High
                </button>
                <button 
                    @click="severityFilter = 'medium'"
                    :class="severityFilter === 'medium' ? 'bg-amber-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    Medium
                </button>
                <button 
                    @click="severityFilter = 'low'"
                    :class="severityFilter === 'low' ? 'bg-green-600 text-white' : 'bg-slate-700 text-gray-300 hover:bg-slate-600'"
                    class="px-3 py-2 rounded text-sm smooth-hover transition-colors"
                >
                    Low
                </button>
            </div>

            <!-- Findings List -->
            <div class="space-y-3">
                <template x-for="(finding, index) in filteredFindings" :key="index">
                    <div 
                        x-data="{ detailsOpen: false }"
                        class="border rounded-lg overflow-hidden relative smooth-hover transition-all duration-200 hover:-translate-y-0.5 hover:shadow-xl hover:shadow-black/40 hover:ring-1 hover:ring-white/10"
                        :class="getSeverityClass(finding.severity) + (((finding.severity || '') + '').toLowerCase() === 'critical' ? ' critical-halo' : '')"
                        :style="getSeverityCardStyle(finding.severity)"
                    >
                        <div class="absolute inset-0 bg-black/60 pointer-events-none rounded-lg"></div>
                        <div class="relative z-10">
                            <button
                                @click="detailsOpen = !detailsOpen"
                                class="w-full px-4 py-3 flex items-center justify-between bg-opacity-90 smooth-hover severity-card-header"
                                :class="getSeverityBgClass(finding.severity)"
                            >
                            <div class="flex items-start space-x-3 flex-1 text-left">
                                <span 
                                    class="inline-block px-2 py-1 rounded text-xs font-semibold mt-0.5 severity-badge"
                                    :class="getSeverityTagClass(finding.severity) + (((finding.severity || '') + '').toLowerCase() === 'critical' ? ' critical-badge-solid' : '')"
                                    :style="getSeverityTagStyle(finding.severity)"
                                    x-text="finding.severity.toUpperCase()"
                                ></span>
                                <div>
                                    <p class="font-semibold text-white" x-text="finding.rule_name"></p>
                                    <p class="text-sm text-white" x-text="finding.description"></p>
                                </div>
                            </div>
                            <svg 
                                class="h-5 w-5 flex-shrink-0 transition-transform duration-200"
                                :class="detailsOpen ? 'rotate-180' : ''"
                                fill="none" 
                                stroke="currentColor" 
                                viewBox="0 0 24 24"
                            >
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                        </button>

                        <!-- Details -->
                        <div x-show="detailsOpen" class="slide-enter">
                            <div class="px-4 py-3 bg-opacity-20">
                                <h4 class="text-sm font-semibold mb-2 text-gray-300">Matched log lines:</h4>
                                <div class="space-y-1">
                                    <template x-for="(line, i) in finding.matched_lines" :key="i">
                                        <div class="bg-slate-900 p-2 rounded text-xs font-mono text-gray-300 break-all overflow-auto" x-text="line"></div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Clear Results -->
            <div class="text-center pt-4">
                <button 
                    @click="clearResults()"
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-gray-200 rounded text-sm smooth-hover transition-colors"
                >
                    New Analysis
                </button>
            </div>
        </div>
    </template>

    <!-- No findings -->
    <template x-if="findings.length === 0 && uploadSuccess && !loading">
        <div class="text-center py-12 bg-slate-800 border border-slate-700 rounded-lg">
            <p class="text-gray-300 text-lg">✓ No suspicious activity detected</p>
            <p class="text-gray-400 text-sm mt-2">The log file appears to be clean</p>
        </div>
    </template>
</div>

<script>
function analyzerApp() {
    return {
        loading: false,
        error: '',
        uploadSuccess: false,
        findings: [],
        isDragging: false,
        activeTab: 'file',
        textInput: '',
        severityFilter: null,

        get findingsByType() {
            return {
                critical: this.findings.filter(f => f.severity === 'critical'),
                high: this.findings.filter(f => f.severity === 'high'),
                medium: this.findings.filter(f => f.severity === 'medium'),
                low: this.findings.filter(f => f.severity === 'low')
            };
        },

        get filteredFindings() {
            if (!this.severityFilter) return this.findings;
            return this.findings.filter(f => f.severity === this.severityFilter);
        },

        handleFileDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length) {
                this.analyzeFile(files[0]);
            }
        },

        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length) {
                this.analyzeFile(files[0]);
            }
        },

        async analyzeFile(file) {
            const allowedExtensions = ['log', 'txt'];
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedExtensions.includes(extension)) {
                this.error = 'Only .log and .txt files are allowed';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                this.error = 'File is too large (maximum 5MB)';
                return;
            }

            this.loading = true;
            this.error = '';
            this.uploadSuccess = false;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    this.error = data.error || 'An error occurred during analysis';
                } else {
                    this.findings = (data.findings || []).map(f => ({
                        ...f,
                        severity: String(f.severity || '').toLowerCase()
                    }));
                    this.uploadSuccess = true;
                    this.error = '';
                }
            } catch (err) {
                this.error = 'Network error: ' + err.message;
            } finally {
                this.loading = false;
            }
        },

        async analyzeText() {
            const raw = this.textInput || '';
            const trimmed = raw.trim();
            this.error = '';

            if (!trimmed) {
                this.error = 'Please paste some log text.';
                return;
            }
            if (raw.length > 200000) {
                this.error = 'Text is too long (max 200,000 characters).';
                return;
            }

            this.loading = true;
            this.uploadSuccess = false;
            try {
                const response = await fetch('/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ log_text: raw })
                });
                const data = await response.json();
                if (!response.ok) {
                    this.error = data.error || 'An error occurred during analysis';
                } else {
                    this.findings = (data.findings || []).map(f => ({
                        ...f,
                        severity: String(f.severity || '').toLowerCase()
                    }));
                    this.uploadSuccess = true;
                    this.error = '';
                }
            } catch (err) {
                this.error = 'Network error: ' + err.message;
            } finally {
                this.loading = false;
            }
        },

        getSeverityClass(severity) {
            const map = {
                'critical': 'border-gray-500/30',
                'high': 'border-red-500/30',
                'medium': 'border-amber-500/30',
                'low': 'border-green-500/30'
            };
            return map[severity] || 'border-gray-500/30';
        },

        getSeverityBgClass(severity) {
            const map = {
                'critical': 'bg-red-900',
                'high': 'bg-red-700',
                'medium': 'bg-amber-500',
                'low': 'bg-green-500'
            };
            return map[severity] || 'bg-gray-500';
        },

        getSeverityTagClass(severity) {
            const map = {
                'critical': 'text-white font-bold px-2.5 py-1 rounded',
                'high': 'text-white font-bold px-2.5 py-1 rounded',
                'medium': 'bg-amber-600 text-white font-bold px-2.5 py-1 rounded',
                'low': 'bg-green-600 text-white font-bold px-2.5 py-1 rounded'
            };
            return map[severity] || 'bg-gray-700 text-gray-100 font-bold px-2.5 py-1 rounded';
        },

        getSeverityTagStyle(severity) {
            if ((severity || '').toLowerCase() === 'critical') {
                return 'background-color:#B71C1C;border:1px solid #B71C1C;color:#FFFFFF;';
            }
            if ((severity || '').toLowerCase() === 'high') {
                return 'background-color:#D32F2F;color:#FFFFFF;';
            }
            return '';
        },

        getSeverityCardStyle(severity) {
            if ((severity || '').toLowerCase() === 'critical') {
                return 'border-left: 6px solid #B71C1C;';
            }
            return '';
        },

        // Backend already HTML-escapes matched_lines exactly once; keep x-text="line" to avoid double-escaping.

        clearResults() {
            this.findings = [];
            this.uploadSuccess = false;
            this.$refs.fileInput.value = '';
            this.textInput = '';
        }
    };
}
</script>
{% endblock %}